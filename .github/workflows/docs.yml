name: Documentation

on:
  push:
    branches: [staging, premain, main]
  pull_request:
    branches: [staging, premain, main]

permissions:
  contents: write

jobs:
  build-and-deploy:
    name: Build and Deploy Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: |
          pnpm --filter @equaltoai/greater-components-tokens build
          pnpm --filter @equaltoai/greater-components-primitives build
          pnpm --filter @equaltoai/greater-components-icons build
          pnpm --filter @equaltoai/greater-components-utils build
          pnpm --filter @equaltoai/greater-components-adapters build
          pnpm --filter @equaltoai/greater-components-headless build
          pnpm --filter @equaltoai/greater-components-fediverse build

      - name: Build playground app
        run: |
          if [ -d "apps/playground" ] && [ -f "apps/playground/package.json" ]; then
            pnpm --filter @equaltoai/playground build
          fi

      - name: Build docs site
        run: |
          if [ -d "apps/docs" ] && [ -f "apps/docs/package.json" ]; then
            pnpm --filter @greater-components/docs build
          fi

      - name: CSP Compliance Check (built output)
        run: pnpm validate:csp

      - name: Prepare deployment bundle
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          rm -rf deploy-dist
          mkdir -p deploy-dist

          # Copy playground to root
          if [ -d "apps/playground/build" ]; then
            cp -R apps/playground/build/* deploy-dist/
          fi

          # Copy docs to /docs subdirectory
          if [ -d "apps/docs/build" ]; then
            mkdir -p deploy-dist/docs
            cp -R apps/docs/build/* deploy-dist/docs/
          fi

          # Disable Jekyll processing
          touch deploy-dist/.nojekyll

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: deploy-dist
          force_orphan: true
