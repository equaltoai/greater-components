name: Main Branch Guard

on:
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  guard:
    name: Enforce release-only main
    runs-on: ubuntu-latest

    steps:
      - name: Require release PR from premain
        run: |
          echo "Base: ${{ github.base_ref }}"
          echo "Head: ${{ github.head_ref }}"
          if [ "${{ github.head_ref }}" != "premain" ]; then
            echo "::error::PRs must target premain. main is release-only. Create this PR against premain instead."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v5

      - name: Validate release metadata
        run: |
          VERSION="$(node -p "require('./package.json').version")"
          TAG="greater-v${VERSION}"

          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]]; then
            echo "::error::package.json version is not valid semver: $VERSION"
            exit 1
          fi

          node - <<'NODE'
          const fs = require('node:fs');

          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const index = JSON.parse(fs.readFileSync('registry/index.json', 'utf8'));
          const latest = JSON.parse(fs.readFileSync('registry/latest.json', 'utf8'));

          const version = pkg.version;
          const tag = `greater-v${version}`;

          const failures = [];

          if (latest.version !== version) failures.push(`registry/latest.json.version must match package.json (${version})`);
          if (latest.ref !== tag) failures.push(`registry/latest.json.ref must be ${tag}`);

          if (index.version !== version) failures.push(`registry/index.json.version must match package.json (${version})`);
          if (index.ref !== tag) failures.push(`registry/index.json.ref must be ${tag}`);

          if (failures.length > 0) {
            for (const msg of failures) console.error(`::error::${msg}`);
            process.exit(1);
          }
          NODE
