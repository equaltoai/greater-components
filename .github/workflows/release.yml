name: Release (main)

on:
  push:
    branches: ['main']
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Optional: upload assets to an existing tag's *draft* release (fails if already published/immutable) (e.g., greater-v0.2.0)"
        required: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for tag-triggered assets)
        if: inputs.tag_name != ''
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ inputs.tag_name }}

      - name: Setup pnpm
        if: inputs.tag_name != ''
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        if: inputs.tag_name != ''
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Upload assets for existing tag release
        if: inputs.tag_name != ''
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN || secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ inputs.tag_name }}
        run: |
          set -euo pipefail

          if [[ -z "${TAG_NAME}" ]]; then
            echo "release-assets: FAIL (missing tag ref_name)"
            exit 1
          fi

          pnpm install --frozen-lockfile

          # Immutable releases block asset/notes changes after publication.
          # We only support mutating draft releases (or creating a draft release) here.
          if ! gh release view "${TAG_NAME}" >/dev/null 2>&1; then
            # Source code zip/tar is auto-attached by GitHub. Assets are uploaded below.
            gh release create "${TAG_NAME}" --generate-notes --draft
          fi

          is_draft="$(gh release view "${TAG_NAME}" --json isDraft --jq '.isDraft')"
          if [[ "${is_draft}" != "true" ]]; then
            echo "release-assets: FAIL (release is already published; immutable releases prevent adding assets/notes)"
            exit 1
          fi

          git fetch origin main premain --force
          bash scripts/verify-release-branch.sh "${TAG_NAME}"

          pnpm build
          node scripts/validate-registry-index.js --strict
          node scripts/validate-release-versions.js
          node scripts/pack-for-release.js

          mapfile -t existing_assets < <(gh release view "${TAG_NAME}" --json assets --jq '.assets[].name' 2>/dev/null || true)

          shopt -s nullglob
          assets=(
            registry/index.json
            registry/latest.json
            artifacts/*
          )

          for asset_path in "${assets[@]}"; do
            asset_name="$(basename "${asset_path}")"
            if printf '%s\n' "${existing_assets[@]}" | grep -Fxq "${asset_name}"; then
              echo "release-assets: skip existing ${asset_name}"
              continue
            fi
            gh release upload "${TAG_NAME}" "${asset_path}"
          done

          prerelease_flag=""
          if [[ "${TAG_NAME}" =~ -rc(\.|$) ]]; then
            prerelease_flag="--prerelease"
          fi

          gh release edit "${TAG_NAME}" --draft=false ${prerelease_flag}

      - name: Release Please (Stable)
        id: release
        if: github.ref == 'refs/heads/main'
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN || secrets.GITHUB_TOKEN }}
          target-branch: main
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          # Prevent release-please from opening the *next* release PR on release commits.
          # PR generation runs in release-pr.yml.
          skip-github-pull-request: true

      - name: Checkout (for release assets)
        if: steps.release.outputs.release_created == 'true'
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup pnpm
        if: steps.release.outputs.release_created == 'true'
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        if: steps.release.outputs.release_created == 'true'
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        if: steps.release.outputs.release_created == 'true'
        run: pnpm install --frozen-lockfile

      - name: Fetch main + premain (release branch verification)
        if: steps.release.outputs.release_created == 'true'
        run: git fetch origin main premain --force

      - name: Verify tag was cut from the correct branch
        if: steps.release.outputs.release_created == 'true'
        run: bash scripts/verify-release-branch.sh "${{ steps.release.outputs.tag_name }}"

      - name: Build packages
        if: steps.release.outputs.release_created == 'true'
        run: pnpm build

      - name: Validate registry index
        if: steps.release.outputs.release_created == 'true'
        run: node scripts/validate-registry-index.js --strict

      - name: Validate release metadata
        if: steps.release.outputs.release_created == 'true'
        run: node scripts/validate-release-versions.js

      - name: Pack release artifacts
        if: steps.release.outputs.release_created == 'true'
        run: node scripts/pack-for-release.js

      - name: Upload release assets
        if: steps.release.outputs.release_created == 'true'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN || secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ steps.release.outputs.tag_name }}
        run: |
          set -euo pipefail

          if [[ -z "${TAG_NAME}" ]]; then
            echo "release-assets: FAIL (missing tag_name output)"
            exit 1
          fi

          # Immutable releases block asset changes after publication.
          # release-please creates the GitHub release as a draft; assert that before uploading.
          is_draft="$(gh release view "${TAG_NAME}" --json isDraft --jq '.isDraft')"
          if [[ "${is_draft}" != "true" ]]; then
            echo "release-assets: FAIL (release is already published; cannot upload assets/notes under immutable releases)"
            exit 1
          fi

          mapfile -t existing_assets < <(gh release view "${TAG_NAME}" --json assets --jq '.assets[].name' 2>/dev/null || true)

          shopt -s nullglob
          assets=(
            registry/index.json
            registry/latest.json
            artifacts/*
          )

          for asset_path in "${assets[@]}"; do
            asset_name="$(basename "${asset_path}")"
            if printf '%s\n' "${existing_assets[@]}" | grep -Fxq "${asset_name}"; then
              echo "release-assets: skip existing ${asset_name}"
              continue
            fi
            gh release upload "${TAG_NAME}" "${asset_path}"
          done

      - name: Publish release (immutable)
        if: steps.release.outputs.release_created == 'true'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN || secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ steps.release.outputs.tag_name }}
        run: |
          set -euo pipefail

          if [[ -z "${TAG_NAME}" ]]; then
            echo "release-assets: FAIL (missing tag_name output)"
            exit 1
          fi

          # If the release is already published, it is immutable (no edits allowed). Treat as no-op.
          is_draft="$(gh release view "${TAG_NAME}" --json isDraft --jq '.isDraft')"
          if [[ "${is_draft}" != "true" ]]; then
            echo "release-assets: skip publish (already published)"
            exit 0
          fi

          gh release edit "${TAG_NAME}" --draft=false
