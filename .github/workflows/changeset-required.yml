name: Changeset Required

on:
  pull_request:
    branches: [staging]

permissions:
  contents: read
  pull-requests: read

jobs:
  changeset:
    name: Require a changeset file
    runs-on: ubuntu-latest

    steps:
      - name: Verify .changeset/*.md exists in PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) {
              core.setFailed('Missing pull_request number in GitHub context');
              return;
            }

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              per_page: 100,
            });

            const isChangeset = (filename) =>
              filename.startsWith('.changeset/') &&
              filename.endsWith('.md') &&
              filename !== '.changeset/README.md';

            const hasChangeset = files.some((f) => isChangeset(f.filename));
            if (!hasChangeset) {
              core.warning(
                'Changesets are no longer required for PRs targeting `staging` (Greater releases are governed by staging -> premain -> main promotions + release-please).'
              );
              core.warning(
                'If you still want a changeset for internal notes, add one in `.changeset/*.md` (create one with `pnpm changeset`).'
              );
            } else {
              core.notice('Found a changeset file in this PR.');
            }
